---
# ConfigMap for CO2 Assistant UI HTML content
apiVersion: v1
kind: ConfigMap
metadata:
  name: co2-assistant-ui-config
  namespace: co2-assistant
  labels:
    app: co2-assistant-ui
    component: frontend
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CO2-Aware Shopping Assistant</title>
        <link rel="stylesheet" href="/style.css">
    </head>
    <body>
        <div class="container">
            <div class="chat-header">
                <div class="eco-icon">üå±</div>
                <h1>CO2-Aware Shopping Assistant</h1>
                <p>Your environmentally conscious shopping companion</p>
                <div class="co2-indicator">
                    <span class="co2-icon">üåø</span>
                    <span id="co2-savings">0 kg CO‚ÇÇ saved</span>
                </div>
            </div>
            
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Ask about products, CO2 impact, or get recommendations..." />
                    <button id="send-button">Send</button>
                </div>
            </div>
            
            <div class="features">
                <h3>üåø Environmental Features</h3>
                <ul>
                    <li>CO2 impact analysis for products</li>
                    <li>Sustainable alternatives suggestions</li>
                    <li>Carbon footprint tracking</li>
                    <li>Eco-friendly shopping recommendations</li>
                </ul>
            </div>
        </div>

        <script src="/script.js"></script>
    </body>
    </html>
  
  style.css: |
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .chat-header {
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .eco-icon {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .chat-header h1 {
        color: #2d5a27;
        margin-bottom: 10px;
        font-size: 2.5rem;
    }

    .chat-header p {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 20px;
    }

    .co2-indicator {
        background: linear-gradient(45deg, #4CAF50, #8BC34A);
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        display: inline-block;
        font-weight: bold;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .co2-icon {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .chat-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        height: 500px;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 15px;
        background: #f9f9f9;
    }

    .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .message.user {
        background: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .message.assistant {
        background: #e9ecef;
        color: #333;
        margin-right: auto;
    }

    .chat-input-container {
        display: flex;
        gap: 10px;
    }

    #chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
    }

    #chat-input:focus {
        border-color: #007bff;
    }

    #send-button {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background 0.3s;
    }

    #send-button:hover {
        background: #0056b3;
    }

    #send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .features {
        background: rgba(255, 255, 255, 0.95);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .features h3 {
        color: #2d5a27;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .features ul {
        list-style: none;
        padding: 0;
    }

    .features li {
        padding: 8px 0;
        color: #666;
        font-size: 1.1rem;
        position: relative;
        padding-left: 25px;
    }

    .features li:before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #4CAF50;
        font-weight: bold;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        
        .chat-header h1 {
            font-size: 2rem;
        }
        
        .chat-container {
            height: 400px;
        }
        
        .message {
            max-width: 90%;
        }
    }

  script.js: |
    class CO2ShoppingAssistant {
        constructor() {
            this.chatInput = document.getElementById('chat-input');
            this.sendButton = document.getElementById('send-button');
            this.chatMessages = document.getElementById('chat-messages');
            this.co2SavingsElement = document.getElementById('co2-savings');
            this.totalCO2Saved = 0;
            
            this.initializeEventListeners();
            this.addWelcomeMessage();
        }
        
        initializeEventListeners() {
            this.sendButton.addEventListener('click', () => this.sendMessage());
            this.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                }
            });
        }
        
        addWelcomeMessage() {
            const welcomeMessage = `
                Welcome to the CO2-Aware Shopping Assistant! üå±<br><br>
                I can help you:<br>
                ‚Ä¢ Find products with lower carbon footprint<br>
                ‚Ä¢ Suggest sustainable alternatives<br>
                ‚Ä¢ Calculate CO2 savings<br>
                ‚Ä¢ Get eco-friendly recommendations<br><br>
                Try asking: "Show me eco-friendly products" or "What's the CO2 impact of this product?"
            `;
            this.addMessage('assistant', welcomeMessage);
        }
        
        async sendMessage() {
            const message = this.chatInput.value.trim();
            if (!message) return;
            
            this.addMessage('user', message);
            this.chatInput.value = '';
            this.sendButton.disabled = true;
            
            try {
                const response = await this.callAPI(message);
                const messageText = response.response?.response || response.response || response;
                this.addMessage('assistant', messageText);
                this.extractAndUpdateCO2Savings(messageText);
            } catch (error) {
                this.addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                console.error('Error:', error);
            } finally {
                this.sendButton.disabled = false;
            }
        }
        
        async callAPI(message) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data.response || 'No response received';
        }
        
        addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = this.renderMarkdown(content);
            this.chatMessages.appendChild(messageDiv);
            this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        }
        
        renderMarkdown(text) {
            // Convert Markdown images to HTML img tags
            let html = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 200px; height: auto; border-radius: 8px; margin: 5px 0;" />');
            
            // Convert **bold** to <strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert line breaks to <br>
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }
        
        extractAndUpdateCO2Savings(response) {
            // 1) Reset on successful checkout - be more specific to avoid false positives
            if (response.includes('Payment Successful!') && response.includes('Order Confirmed')) {
                this.totalCO2Saved = 0;
                this.updateCO2Display();
                return;
            }

            // 2) CO2 Impact from cart/checkout: "üåç **CO2 Impact**: 44.5 kg CO2" or "üåç **Total CO2**: 93.5 kg"
            // Handle both markdown (**bold**) and HTML (<strong>bold</strong>) formats
            const co2ImpactMatch = response.match(/üåç\s*(?:\*\*CO2\s+Impact\*\*|<strong>CO2\s+Impact<\/strong>|\*\*Total\s+CO2\*\*|<strong>Total\s+CO2<\/strong>):\s*(\d+(?:\.\d+)?)\s*kg/i);
            if (co2ImpactMatch) {
                const co2Value = parseFloat(co2ImpactMatch[1]);
                if (!Number.isNaN(co2Value)) {
                    this.totalCO2Saved = Math.max(0, co2Value);
                    this.updateCO2Display();
                    return;
                }
            }
            
            // 2b) Simpler pattern for CO2 Impact: "üåç **CO2 Impact**: 44.5 kg"
            const simpleCo2Match = response.match(/üåç\s*\*\*CO2\s+Impact\*\*:\s*(\d+(?:\.\d+)?)\s*kg/i);
            if (simpleCo2Match) {
                const co2Value = parseFloat(simpleCo2Match[1]);
                if (!Number.isNaN(co2Value)) {
                    this.totalCO2Saved = Math.max(0, co2Value);
                    this.updateCO2Display();
                    return;
                }
            }
            
            // 2c) Pattern for Total CO2: "üåç **Total CO2**: 93.5 kg"
            const totalCo2Match = response.match(/üåç\s*\*\*Total\s+CO2\*\*:\s*(\d+(?:\.\d+)?)\s*kg/i);
            if (totalCo2Match) {
                const co2Value = parseFloat(totalCo2Match[1]);
                if (!Number.isNaN(co2Value)) {
                    this.totalCO2Saved = Math.max(0, co2Value);
                    this.updateCO2Display();
                    return;
                }
            }
            
            // 2d) Pattern for Cart Totals: "‚Ä¢ **Total CO2**: 93.5 kg"
            const cartTotalMatch = response.match(/‚Ä¢\s*\*\*Total\s+CO2\*\*:\s*(\d+(?:\.\d+)?)\s*kg/i);
            if (cartTotalMatch) {
                const co2Value = parseFloat(cartTotalMatch[1]);
                if (!Number.isNaN(co2Value)) {
                    this.totalCO2Saved = Math.max(0, co2Value);
                    this.updateCO2Display();
                    return;
                }
            }

            // 3) Explicit savings statement: "44.5 kg CO‚ÇÇ saved"
            const savedMatch = response.match(/(\d+(?:\.\d+)?)\s*kg\s*CO[‚ÇÇ2]\s*saved/i);
            if (savedMatch) {
                const saved = parseFloat(savedMatch[1]);
                if (!Number.isNaN(saved)) {
                    this.totalCO2Saved = Math.max(0, saved);
                    this.updateCO2Display();
                    return;
                }
            }

            // 4) Multi-item savings phrasing (ProductDiscoveryAgent):
            //    "Estimated savings choosing efficient options: 1.2kg per item"
            const perItemSavings = response.match(/Estimated\s+savings\s+choosing\s+efficient\s+options:\s*(\d+(?:\.\d+)?)\s*kg\s*per\s*item/i);
            if (perItemSavings) {
                const perItem = parseFloat(perItemSavings[1]);
                if (!Number.isNaN(perItem)) {
                    this.totalCO2Saved = Math.max(0, perItem);
                    this.updateCO2Display();
                    return;
                }
            }
            
            // 5) Try simpler patterns for multi-item
            const simplePerItem = response.match(/(\d+(?:\.\d+)?)\s*kg\s*per\s*item/i);
            if (simplePerItem) {
                const perItem = parseFloat(simplePerItem[1]);
                if (!Number.isNaN(perItem)) {
                    this.totalCO2Saved = Math.max(0, perItem);
                    this.updateCO2Display();
                    return;
                }
            }
        }
        
        updateCO2Display() {
            if (this.co2SavingsElement) {
                this.co2SavingsElement.textContent = `${this.totalCO2Saved.toFixed(1)} kg CO‚ÇÇ saved`;
                this.co2SavingsElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    this.co2SavingsElement.style.transform = 'scale(1)';
                }, 200);
            }
        }
    }
    
    // Initialize the assistant when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        new CO2ShoppingAssistant();
    });